C51 COMPILER V9.60.0.0   DS1302                                                            01/02/2021 20:11:12 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ..\output\DS1302.obj
COMPILER INVOKED BY: D:\app\keil\C51\BIN\C51.EXE ..\source\DS1302.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\
                    -Listings\DS1302.lst) TABS(2) OBJECT(..\output\DS1302.obj)

line level    source

   1          #include "config.h"
   2          #include "DS1302.h"
   3          #include "LCD1602.h"
   4          
   5          /*=================================================
   6          *º¯ÊýÃû³Æ£ºDS1302_W_Byte
   7          *º¯Êý¹¦ÄÜ£ºDS1302Ð´Ò»×Ö½ÚÊý¾Ý
   8          *ÊäÈë£ºdat£ºÒªÐ´ÈëµÄÊý¾Ý
   9          =================================================*/
  10          void DS1302_W_Byte(uint8 dat)
  11          {
  12   1        uint8 i;
  13   1        for(i = 0; i < 8; i++) //Ã¿´ÎÐ´1bit£¬Ð´8´Î
  14   1        {
  15   2          TSCLK = 0;       //À­µÍÊ±ÖÓ×ÜÏß
  16   2          TIO = dat & 0x01;  //´ÓÒ»×Ö½Ú×îµÍÎ»¿ªÊ¼Ð´
  17   2          TSCLK = 1;       //À­¸ßÊ±ÖÓ×ÜÏß£¬DS1302°ÑÊý¾Ý¶Á×ß
  18   2          dat >>= 1;       //Êý¾ÝÓÒÒÆÒ»Î» 
  19   2        } 
  20   1      }
  21          /*=================================================
  22          *º¯ÊýÃû³Æ£ºDS1302_R_Byte
  23          *º¯Êý¹¦ÄÜ£ºDS1302¶ÁÒ»×Ö½Ú
  24          *Êä³ö£ºdat£º¶ÁÈ¡µÄÊý¾Ý
  25          =================================================*/
  26          uint8 DS1302_R_Byte()
  27          {
  28   1        uint8 i, dat;
  29   1        for(i = 0; i < 8; i++)  //Ã¿´ÎÐ´1bit£¬Ð´8´Î
  30   1        {
  31   2          TSCLK = 0;      //À­µÍÊ±ÖÓ×ÜÏß£¬DS1302°ÑÊý¾Ý·Åµ½Êý¾Ý×ÜÏßÉÏ
  32   2          dat >>= 1;      //Êý¾ÝÓÒÒÆÒ»Î»£¬Êý¾Ý´Ó×îµÍÎ»¿ªÊ¼¶Á 
  33   2          if(TIO) dat |= 0x80;//¶ÁÈ¡Êý¾Ý
  34   2          TSCLK = 1;      //À­¸ßÊ±ÖÓ×ÜÏß
  35   2        }
  36   1        return dat;       //·µ»Ø¶ÁÈ¡µÄÊý¾Ý
  37   1      }
  38          /*=================================================
  39          *º¯ÊýÃû³Æ£ºDS1302_W_DAT
  40          *º¯Êý¹¦ÄÜ£ºÐ´DS1302Êý¾ÝÒ»´ÎÐ´2¸ö×Ö½Ú
  41          *ËµÃ÷£ºÏÈÐ´ÃüÁîºóÐ´Êý¾Ý
  42          *µ÷ÓÃ£ºDS1302_W_Byte()
  43          *ÊäÈë£ºcmd£ºÐèÒªÐ´µÄÃüÁî £¬dat£ºÐèÒªÐ©µÄÊý¾Ý
  44          =================================================*/
  45          void DS1302_W_DAT(uint8 cmd, uint8 dat)
  46          {
  47   1        TRST = 0;      //
  48   1        TRST = 1;      //TRSTÉÏÉýÑØ¿ªÊ¼¶ÁÐ´Êý¾Ý
  49   1        DS1302_W_Byte(cmd);  //Ð´ÃüÁî
  50   1        DS1302_W_Byte(dat);  //Ð´Êý¾Ý
  51   1        TRST = 0;      //½ûÖ¹¶ÁÐ´Êý¾Ý
  52   1      }
  53          /*=================================================
  54          *º¯ÊýÃû³Æ£ºDS1302_R_DAT
C51 COMPILER V9.60.0.0   DS1302                                                            01/02/2021 20:11:12 PAGE 2   

  55          *º¯Êý¹¦ÄÜ£º¶ÁDS1302Êý¾Ý
  56          *ËµÃ÷£ºÏÈÐ´ÈëÃüÁî×Ö½Úºó¶Á³ö¶ÔÓ¦Êý¾Ý
  57          *µ÷ÓÃ£º DS1302_W_Byte();DS1302_R_Byte();
  58          *ÊäÈë£º cmd£ºÐèÒªÐ´µÄÃüÁî
  59          *Êä³ö£º dat£º¶Á³öµÄÊý¾Ý
  60          =================================================*/
  61          /*uint8 DS1302_R_DAT(uint8 cmd) //´Ë³ÌÐòÖÐÎ´Ê¹ÓÃ´Ëº¯Êý
  62          {
  63            uint8 dat;
  64            TRST = 0;       //
  65            TRST = 1;       //TRSTÉÏÉýÑØ¿ªÊ¼¶ÁÐ´Êý¾Ý
  66            DS1302_W_Byte(cmd);   //Ð´ÃüÁî
  67            dat = DS1302_R_Byte();  //¶Á³öÊý¾Ý
  68            TRST = 0;       //½ûÖ¹¶ÁÐ´Êý¾Ý
  69            return dat;       //·µ»Ø¶Á³öÊý¾Ý
  70          }  */
  71          /*=================================================
  72          *º¯ÊýÃû³Æ£ºDS1302_Clear_WP
  73          *º¯Êý¹¦ÄÜ£ºÇå³ýDS1302Ð´±£»¤
  74          *ËµÃ÷£ºÏÈÐ´ÈëÃüÁî0x8e£¨Ð´¿ØÖÆ¼Ä´æÆ÷£©½Ó×ÅÏò¸Ã¼Ä´æÆ÷Ð´0
  75          *µ÷ÓÃ£ºDS1302_W_DAT()
  76          =================================================*/
  77          void DS1302_Clear_WP()
  78          {
  79   1        DS1302_W_DAT(0x8e,0x00);  //°Ñ¿ØÖÆ¼Ä´æÆ÷WPÎ»ÖÃ0
  80   1      }
  81          /*=================================================
  82          *º¯ÊýÃû³Æ£ºDS1302_Set_WP
  83          *º¯Êý¹¦ÄÜ£ºÉèÖÃDS1302Ð´±£»¤
  84          *ËµÃ÷£ºÏÈÐ´ÈëÃüÁî0x8e£¨Ð´¿ØÖÆ¼Ä´æÆ÷£©½Ó×ÅÏò¸Ã¼Ä´æÆ÷Ð´0x80
  85          *µ÷ÓÃ£ºDS1302_W_DAT()
  86          =================================================*/
  87          void DS1302_Set_WP()
  88          { 
  89   1        DS1302_W_DAT(0x8e,0x80); //°Ñ¿ØÖÆ¼Ä´æÆ÷WPÎ»ÖÃ1
  90   1        TRST = 0;        //À­µÍÊ¹ÄÜ¶Ë
  91   1        TSCLK = 0;         //À­µÍÊý¾Ý×ÜÏß
  92   1      } 
  93          /*=================================================
  94          *º¯ÊýÃû³Æ£ºDS1302_Burst_Write
  95          *º¯Êý¹¦ÄÜ£ºÍ»·¢Ä£Ê½Ð´DS1302Ê±ÖÓÈÕÀúÊý¾Ý
  96          *ËµÃ÷£ºÐ´Èë8¸ö×Ö½ÚµÄÊý¾Ýµ½DS1302Ê±ÖÓÈÕÀú¼Ä´æÆ÷ÖÐ
  97          *µ÷ÓÃ£ºDS1302_Clear_WP();DS1302_W_Byte();DS1302_Set_WP();
  98          =================================================*/
  99          void DS1302_Burst_Write(uint8 *dat)
 100          {
 101   1        uint8 i;
 102   1        DS1302_Clear_WP();    //Çå³ýÐ´±£»¤
 103   1        TRST = 0;       //À­µÍÊ¹ÄÜ¶Ë
 104   1        TSCLK = 0;        //À­µÍÊý¾Ý×ÜÏß
 105   1        TRST = 1;       //À­¸ßÊ¹ÄÜ¶Ë£¬¿ªÊ¼Ð´Êý¾Ý
 106   1        DS1302_W_Byte(0xbe); //Ð´Ê±ÖÓÍ»·¢Ä£Ê½¼Ä´æÆ÷
 107   1        for(i = 0; i < 8; i++)  //Ð´Èë8¸ö×Ö½ÚµÄÊ±ÖÓ³õÊ¼Öµ
 108   1        {
 109   2          DS1302_W_Byte(dat[i]); //ÔÚÍ»·¢Ä£Ê½ÏÂ¿ÉÒÔÁ¬ÐøÐ´Êý¾Ý
 110   2        }
 111   1        DS1302_Set_WP(); //¿ªÆðÐ´±£»¤   
 112   1      }
 113          /*=================================================
 114          *º¯ÊýÃû³Æ£ºDS1302_Burst_Read
 115          *º¯Êý¹¦ÄÜ£ºÍ»·¢Ä£Ê½¶ÁDS1302Ê±ÖÓÈÕÀúÊý¾Ý
 116          *ËµÃ÷£º ¶ÁÈ¡8¸ö×Ö½ÚµÄDS1302Ê±ÖÓÈÕÀúÊý¾Ý
C51 COMPILER V9.60.0.0   DS1302                                                            01/02/2021 20:11:12 PAGE 3   

 117              Êý×éTimeData£¨Êý¾Ý¸ñÊ½BCDÂë£©
 118          *µ÷ÓÃ£ºDS1302_Clear_WP();DS1302_R_Byte();DS1302_Set_WP();
 119          =================================================*/
 120          void DS1302_Burst_Read(uint8 *dat)
 121          {
 122   1        uint8 i;
 123   1        DS1302_Clear_WP();      //Çå³ýÐ´±£»¤
 124   1        TRST = 0;       //À­µÍÊ¹ÄÜ¶Ë
 125   1        TSCLK = 0;        //À­µÍÊý¾Ý×ÜÏß
 126   1        TRST = 1;       //À­¸ßÊ¹ÄÜ¶Ë£¬¿ªÊ¼Ð´Êý¾Ý
 127   1        DS1302_W_Byte(0xbf); //Ð´ ¶ÁÍ»·¢Ä£Ê½¼Ä´æÆ÷ÃüÁî
 128   1        for(i = 0; i < 8; i++)  //´ÓDS1302¶ÁÈ¡7¸ö×Ö½ÚµÄÊ±ÖÓÈÕÀúÊý¾Ý
 129   1        {
 130   2          dat[i] = DS1302_R_Byte();//ÔÚÍ»·¢Ä£Ê½ÏÂ¿ÉÒÔÁ¬Ðø¶ÁÊý¾Ý
 131   2        }
 132   1        DS1302_Set_WP();   //¿ªÆðÐ´±£»¤
 133   1      }
 134          /*=================================================
 135          *º¯ÊýÃû³Æ£ºGetRealTime
 136          *º¯Êý¹¦ÄÜ£ºÍ»·¢Ä£Ê½¶ÁDS1302Ê±ÖÓÈÕÀúÊý¾Ý£¬²¢×ªÎªÊ±¼ä¸ñÊ½
 137          =================================================*/
 138          void GetRealTime(struct sTime *time)
 139          {
 140   1          uint8 buf[8];
 141   1          
 142   1          DS1302_Burst_Read(buf);
 143   1          time->year = buf[6] + 0x2000;  //Äê£¬ÒòÎªDS1302Ö»ÄÜÊÇ0-99ÈçÏÔÊ¾2012ÄêÔòÍ¨¹ý2000ÕâÖÖ·½·¨ÏÔÊ¾ÄêµÄÇ§Î»ºÍ°
             -ÙÎ»
 144   1          time->mon  = buf[4];
 145   1          time->day  = buf[3];
 146   1          time->hour = buf[2];
 147   1          time->min  = buf[1];
 148   1          time->sec  = buf[0];
 149   1          time->week = buf[5];
 150   1      }
 151          /*=================================================
 152          *º¯ÊýÃû³Æ£ºSetRealTime
 153          *º¯Êý¹¦ÄÜ£ºÍ»·¢Ä£Ê½ÉèÖÃDS1302Ê±ÖÓÈÕÀúÊý¾Ý
 154          =================================================*/ 
 155          void SetRealTime(struct sTime *time)
 156          {
 157   1          uint8 buf[8];
 158   1          
 159   1          buf[7] = 0;
 160   1          buf[6] = time->year;
 161   1          buf[5] = time->week;
 162   1          buf[4] = time->mon;
 163   1          buf[3] = time->day;
 164   1          buf[2] = time->hour;
 165   1          buf[1] = time->min;
 166   1          buf[0] = time->sec;
 167   1          DS1302_Burst_Write(buf);
 168   1      }
 169          /*=================================================
 170          *º¯ÊýÃû³Æ£ºInit_DS1302
 171          *º¯Êý¹¦ÄÜ£º³õÊ¼»¯DS1302²¢ÉèÖÃÄ¬ÈÏÊ±¼ä £º2017-08-01 23:59:50 ÐÇÆÚ¶þ
 172          =================================================*/ 
 173          void Init_DS1302()
 174          {
 175   1          struct sTime code InitTime[] = { 
 176   1              0x2017 , 0x08, 0x01, 0x23, 0x59, 0x50, 0x02
 177   1          };  
C51 COMPILER V9.60.0.0   DS1302                                                            01/02/2021 20:11:12 PAGE 4   

 178   1        
 179   1          SetRealTime(&InitTime);      //ÉèÖÃDS1302ÎªÄ¬ÈÏµÄ³õÊ¼Ê±¼ä
 180   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    365    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
